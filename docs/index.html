<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Tracker - Âü∫Èáë‰º∞ÂÄºÁúãÊùø</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10b981',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // È£éÈô©ËØÑÁ∫ßÊéíÂ∫èÊùÉÈáç
        const RISK_ORDER = { 'R1 ‰ΩéÈ£éÈô©': 1, 'R2 ‰∏≠‰ΩéÈ£éÈô©': 2, 'R3 ‰∏≠Á≠âÈ£éÈô©': 3, 'R4 ‰∏≠È´òÈ£éÈô©': 4, 'R5 È´òÈ£éÈô©': 5 };

        // --- Icons ---
        const IconTrendingUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const IconTrendingDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>;
        const IconRefresh = ({ spin }) => <svg className={spin ? "animate-spin" : ""} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
        const IconSort = ({ dir }) => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">{dir === 'asc' ? <polyline points="18 15 12 9 6 15"/> : <polyline points="6 9 12 15 18 9"/>}</svg>;

        const RiskBadge = ({ level }) => {
            if (!level) return null;
            const colorMap = {
                'R1': 'bg-emerald-50 text-emerald-600 border-emerald-200',
                'R2': 'bg-blue-50 text-blue-600 border-blue-200',
                'R3': 'bg-yellow-50 text-yellow-600 border-yellow-200',
                'R4': 'bg-orange-50 text-orange-600 border-orange-200',
                'R5': 'bg-red-50 text-red-600 border-red-200',
            };
            const key = level.startsWith('R') ? level.substring(0, 2) : '';
            const cls = colorMap[key] || 'bg-gray-50 text-gray-600 border-gray-200';
            return <span className={`text-xs border px-1.5 py-0.5 rounded font-mono ${cls}`}>{level}</span>;
        };

        const StatCard = ({ label, value, trend }) => {
            const colorClass = trend > 0 ? 'text-red-500' : (trend < 0 ? 'text-emerald-500' : 'text-gray-500');
            return (
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                    <span className="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">{label}</span>
                    <span className={`text-2xl font-bold ${colorClass}`}>{value}</span>
                </div>
            );
        };

        const FundRow = ({ fund }) => {
            const isUp = parseFloat(fund['Ê∂®Ë∑åÂπÖ']) > 0;
            const isDown = parseFloat(fund['Ê∂®Ë∑åÂπÖ']) < 0;
            const trendColor = isUp ? 'text-red-500' : (isDown ? 'text-emerald-500' : 'text-gray-500');
            const diffSign = isUp ? '+' : '';
            
            return (
                <div className="bg-white rounded-xl p-4 mb-3 border border-gray-100 shadow-sm hover:shadow-md transition-all duration-200 flex flex-wrap items-center gap-4 fade-in">
                    <div className="flex-1 min-w-[200px]">
                        <div className="flex items-center gap-2">
                             <h3 className="font-bold text-gray-800">{fund['Âü∫ÈáëÂêçÁß∞']}</h3>
                             <span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">{fund['Âü∫Èáë‰ª£Á†Å']}</span>
                             <RiskBadge level={fund['È£éÈô©ËØÑÁ∫ß']} />
                        </div>
                        <div className="text-xs text-gray-400 mt-1 flex gap-2 flex-wrap">
                            <span>{fund['Êù•Ê∫ê'] || 'ÂÖ∂‰ªñ'}</span>
                            <span>‚Ä¢</span>
                            <span>{fund['Á±ªÂûã'] || 'Ê∑∑ÂêàÂûã'}</span>
                            <span>‚Ä¢</span>
                            <span>{fund['Êõ¥Êñ∞Êó∂Èó¥']}</span>
                        </div>
                    </div>
                    
                    <div className="flex flex-col items-end min-w-[100px]">
                        <span className="text-xs text-gray-400">ÂΩìÂâç‰º∞ÂÄº</span>
                        <span className="font-mono font-medium text-gray-700">{fund['ÂΩìÂâç‰º∞ÂÄº']}</span>
                    </div>

                    <div className="flex flex-col items-end min-w-[100px]">
                        <span className="text-xs text-gray-400">Ê∂®Ë∑åÂπÖ</span>
                        <div className={`flex items-center gap-1 font-bold ${trendColor}`}>
                            {isUp && <IconTrendingUp />}
                            {isDown && <IconTrendingDown />}
                            <span>{diffSign}{(parseFloat(fund['Ê∂®Ë∑åÂπÖ']) * 100).toFixed(2)}%</span>
                        </div>
                    </div>
                    
                    <div className="flex flex-col items-end min-w-[100px]">
                        <span className="text-xs text-gray-400">È¢Ñ‰º∞Áõà‰∫è</span>
                        <span className={`font-mono text-sm ${trendColor}`}>{fund['Ê∂®Ë∑åÈ¢ù']}</span>
                    </div>
                </div>
            )
        }

        const App = () => {
            const [fundList, setFundList] = useState([]);
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [sortBy, setSortBy] = useState('Ê∂®Ë∑åÂπÖ');
            const [sortDir, setSortDir] = useState('desc');
            const [groupBy, setGroupBy] = useState('none');

            // Ê†πÊçÆ URL ?u=user1 / ?u=user2 ÈÄâÊã©Âü∫ÈáëÂàóË°®
            const USER_FUND_MAP = {
                'user1': 'funds.json',
                'user2': 'funds_user2.json',
            };
            const urlUser = new URLSearchParams(window.location.search).get('u') || 'user1';
            const fundFile = USER_FUND_MAP[urlUser] || 'funds.json';

            const loadFunds = async () => {
                try {
                    const response = await fetch(`https://raw.githubusercontent.com/Triplefish/x7k2m/main/data/${fundFile}`);
                    const funds = await response.json();
                    setFundList(funds);
                    return funds;
                } catch (err) {
                    console.error('Failed to load funds from GitHub:', err);
                    return [];
                }
            };

            // Ëé∑ÂèñÂü∫Èáë‰º∞ÂÄºÊï∞ÊçÆÔºà‰ΩøÁî® JSONP ÁªïËøá CORSÔºåÊé•Âè£Âõ∫ÂÆöÂõûË∞ÉÂêç jsonpgzÔºåÈ°∫Â∫èÂä†ËΩΩÔºâ
            const fetchFundJsonp = (code) => {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    const timer = setTimeout(() => {
                        window.jsonpgz = null;
                        if (document.body.contains(script)) document.body.removeChild(script);
                        reject(new Error('timeout'));
                    }, 8000);
                    window.jsonpgz = (data) => {
                        clearTimeout(timer);
                        window.jsonpgz = null;
                        if (document.body.contains(script)) document.body.removeChild(script);
                        resolve(data);
                    };
                    script.onerror = () => {
                        clearTimeout(timer);
                        window.jsonpgz = null;
                        if (document.body.contains(script)) document.body.removeChild(script);
                        reject(new Error('load error'));
                    };
                    script.src = `https://fundgz.1234567.com.cn/js/${code}.js?v=${Date.now()}`;
                    document.body.appendChild(script);
                });
            };

            const getFundEstimates = async (funds) => {
                const results = [];
                
                for (const fund of funds) {
                    try {
                        const fundData = await fetchFundJsonp(fund.code);
                        
                        const fundName = fundData['name'];
                        const latestNav = parseFloat(fundData['dwjz']);
                        const estimateNav = fundData['gsz'];
                        const estimateTime = fundData['gztime'] || fundData['jzrq'] || '';
                        
                        if (estimateNav && estimateNav !== '') {
                            const estNav = parseFloat(estimateNav);
                            const changePct = (estNav - latestNav) / latestNav;
                            const changeAmount = estNav - latestNav;
                            
                            results.push({
                                'Âü∫ÈáëÂêçÁß∞': fundName,
                                'Âü∫Èáë‰ª£Á†Å': fund.code,
                                'Êù•Ê∫ê': fund.source || 'ÂÖ∂‰ªñ',
                                'Á±ªÂûã': fund.type || '',
                                'È£éÈô©ËØÑÁ∫ß': fund.risk_level || '',
                                'Êò®Êó•ÂáÄÂÄº': latestNav.toFixed(4),
                                'ÂΩìÂâç‰º∞ÂÄº': estNav.toFixed(4),
                                'Ê∂®Ë∑åÂπÖ': changePct.toFixed(6),
                                'Ê∂®Ë∑åÈ¢ù': changeAmount.toFixed(4),
                                'Êõ¥Êñ∞Êó∂Èó¥': estimateTime
                            });
                        }
                    } catch (err) {
                        console.error(`Failed to get data for ${fund.code}:`, err);
                    }
                }
                
                return results;
            };

            const loadData = async () => {
                setLoading(true);
                try {
                    const funds = await loadFunds();
                    if (funds && funds.length > 0) {
                        const estimates = await getFundEstimates(funds);
                        setData(estimates);
                    }
                } catch (err) {
                    console.error('Error loading data:', err);
                } finally {
                    setLoading(false);
                }
            };

            const toggleSort = (field) => {
                if (sortBy === field) {
                    setSortDir(d => d === 'desc' ? 'asc' : 'desc');
                } else {
                    setSortBy(field);
                    setSortDir('desc');
                }
            };

            useEffect(() => {
                loadData();
            }, []);

            // ËÆ°ÁÆóÁªüËÆ°‰ø°ÊÅØ
            const stats = useMemo(() => {
                if(!data.length) return { avgChange: 0, upCount: 0, downCount: 0 };
                let totalPct = 0;
                let up = 0;
                let down = 0;
                let validCount = 0;
                
                data.forEach(d => {
                    const pct = parseFloat(d['Ê∂®Ë∑åÂπÖ']);
                    if(!isNaN(pct)) {
                        totalPct += pct;
                        if(pct > 0) up++; 
                        if(pct < 0) down++;
                        validCount++;
                    }
                });
                return {
                    avgChange: validCount ? (totalPct / validCount * 100).toFixed(2) : 0,
                    upCount: up,
                    downCount: down
                };
            }, [data]);

            // ÊéíÂ∫è + ÂàÜÁªÑ
            const processedData = useMemo(() => {
                const sorted = [...data].sort((a, b) => {
                    let va, vb;
                    if (sortBy === 'Ê∂®Ë∑åÂπÖ') {
                        va = parseFloat(a['Ê∂®Ë∑åÂπÖ']) || 0;
                        vb = parseFloat(b['Ê∂®Ë∑åÂπÖ']) || 0;
                    } else if (sortBy === 'Âü∫ÈáëÂêçÁß∞') {
                        return sortDir === 'asc'
                            ? (a['Âü∫ÈáëÂêçÁß∞'] || '').localeCompare(b['Âü∫ÈáëÂêçÁß∞'] || '')
                            : (b['Âü∫ÈáëÂêçÁß∞'] || '').localeCompare(a['Âü∫ÈáëÂêçÁß∞'] || '');
                    } else if (sortBy === 'È£éÈô©ËØÑÁ∫ß') {
                        va = RISK_ORDER[a['È£éÈô©ËØÑÁ∫ß']] || 99;
                        vb = RISK_ORDER[b['È£éÈô©ËØÑÁ∫ß']] || 99;
                    } else if (sortBy === 'Êù•Ê∫ê') {
                        return sortDir === 'asc'
                            ? (a['Êù•Ê∫ê'] || '').localeCompare(b['Êù•Ê∫ê'] || '')
                            : (b['Êù•Ê∫ê'] || '').localeCompare(a['Êù•Ê∫ê'] || '');
                    } else {
                        return 0;
                    }
                    return sortDir === 'desc' ? vb - va : va - vb;
                });

                if (groupBy === 'none') return [{ key: null, items: sorted }];

                const groups = {};
                sorted.forEach(f => {
                    const key = f[groupBy] || 'Êú™Áü•';
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(f);
                });

                let keys = Object.keys(groups);
                if (groupBy === 'È£éÈô©ËØÑÁ∫ß') {
                    keys = keys.sort((a, b) => (RISK_ORDER[a] || 99) - (RISK_ORDER[b] || 99));
                } else {
                    keys = keys.sort();
                }
                return keys.map(k => ({ key: k, items: groups[k] }));
            }, [data, sortBy, sortDir, groupBy]);

            return (
                <div className="min-h-screen pb-12">
                    {/* Header */}
                    <div className="bg-white border-b border-gray-200 sticky top-0 z-30 bg-opacity-80 backdrop-blur-md">
                        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary">
                                    <IconTrendingUp />
                                </div>
                                <div>
                                    <h1 className="font-bold text-xl text-gray-900 tracking-tight">Âü∫ÈáëËøΩË∏™</h1>
                                    <p className="text-xs text-gray-400">ÂÆûÊó∂‰º∞ÂÄºÁúãÊùø</p>
                                </div>
                            </div>
                            <button 
                                onClick={loadData} 
                                className="p-2 text-gray-500 hover:text-primary hover:bg-gray-50 rounded-lg transition-all"
                                title="Âà∑Êñ∞"
                                disabled={loading}
                            >
                                <IconRefresh spin={loading} />
                            </button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-4xl mx-auto px-4 py-8">
                        
                        {/* Stats Row */}
                        <div className="grid grid-cols-3 gap-4 mb-8">
                            <StatCard 
                                label="Âπ≥ÂùáÊ∂®Ë∑å" 
                                value={`${stats.avgChange > 0 ? '+' : ''}${stats.avgChange}%`} 
                                trend={parseFloat(stats.avgChange)}
                            />
                            <StatCard 
                                label="‰∏äÊ∂®Âü∫Èáë" 
                                value={stats.upCount} 
                                trend={1}
                            />
                            <StatCard 
                                label="‰∏ãË∑åÂü∫Èáë" 
                                value={stats.downCount} 
                                trend={-1}
                            />
                        </div>

                        {/* Sort & Group Controls */}
                        <div className="flex flex-wrap items-center gap-3 mb-5">
                            <div className="flex items-center gap-1.5">
                                <span className="text-xs text-gray-400 font-medium">ÊéíÂ∫è</span>
                                {['Ê∂®Ë∑åÂπÖ', 'Âü∫ÈáëÂêçÁß∞', 'È£éÈô©ËØÑÁ∫ß', 'Êù•Ê∫ê'].map(f => (
                                    <button key={f} onClick={() => toggleSort(f)}
                                        className={`flex items-center gap-0.5 text-xs px-2.5 py-1 rounded-full border transition-all ${
                                            sortBy === f
                                                ? 'bg-gray-900 text-white border-gray-900'
                                                : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'
                                        }`}>
                                        {f}
                                        {sortBy === f && <IconSort dir={sortDir} />}
                                    </button>
                                ))}
                            </div>
                            <div className="w-px h-4 bg-gray-200"/>
                            <div className="flex items-center gap-1.5">
                                <span className="text-xs text-gray-400 font-medium">ÂàÜÁªÑ</span>
                                {[{v:'none',l:'Êó†'},{v:'Êù•Ê∫ê',l:'Êù•Ê∫ê'},{v:'Á±ªÂûã',l:'Á±ªÂûã'},{v:'È£éÈô©ËØÑÁ∫ß',l:'È£éÈô©'}].map(({v,l}) => (
                                    <button key={v} onClick={() => setGroupBy(v)}
                                        className={`text-xs px-2.5 py-1 rounded-full border transition-all ${
                                            groupBy === v
                                                ? 'bg-gray-900 text-white border-gray-900'
                                                : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'
                                        }`}>{l}</button>
                                ))}
                            </div>
                        </div>

                        {/* List */}
                        <div className="space-y-1">
                            {loading && data.length === 0 ? (
                                <div className="text-center py-12 text-gray-400">
                                    <div className="animate-pulse">Âä†ËΩΩ‰∏≠...</div>
                                </div>
                            ) : processedData.length > 0 && processedData[0].items.length > 0 ? (
                                processedData.map(group => (
                                    <div key={group.key || 'all'}>
                                        {group.key && (
                                            <div className="flex items-center gap-2 mb-2 mt-4 first:mt-0">
                                                <span className="text-xs font-semibold text-gray-500 uppercase tracking-wider">{group.key}</span>
                                                <span className="text-xs text-gray-300 bg-gray-100 px-1.5 py-0.5 rounded-full">{group.items.length}</span>
                                                <div className="flex-1 h-px bg-gray-100"/>
                                            </div>
                                        )}
                                        {group.items.map(fund => (
                                            <FundRow key={fund['Âü∫Èáë‰ª£Á†Å']} fund={fund} />
                                        ))}
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-12">
                                    <div className="bg-white w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                                        <span className="text-2xl">üì≠</span>
                                    </div>
                                    <h3 className="text-gray-900 font-medium">Êú™ËÉΩÂä†ËΩΩÊï∞ÊçÆ</h3>
                                    <p className="text-gray-400 text-sm mt-1">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
