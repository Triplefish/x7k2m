name: 基金估值追踪

on:
  schedule:
    # 交易日开盘后每15分钟 (北京时间9:30-14:15)
    - cron: '30,45 1 * * 1-5'  # 9:30, 9:45
    - cron: '0,15,30,45 2 * * 1-5'  # 10:00, 10:15, 10:30, 10:45
    - cron: '0,15,30 3 * * 1-5'  # 11:00, 11:15, 11:30
    - cron: '0,15,30,45 5 * * 1-5'  # 13:00, 13:15, 13:30, 13:45
    - cron: '0,15 6 * * 1-5'  # 14:00, 14:15
    # 收盘前每5分钟 (北京时间14:30-15:00)
    - cron: '30,35,40,45,50,55 6 * * 1-5'  # 14:30, 14:35, 14:40, 14:45, 14:50, 14:55
    - cron: '0 7 * * 1-5'  # 15:00
  
  workflow_dispatch:  # 允许手动触发

jobs:
  update-fund-tracker:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置 Python 环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: 安装依赖
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 运行基金估值追踪
      env:
        VIKA_API_TOKEN: ${{ secrets.VIKA_API_TOKEN }}
        VIKA_DATASHEET_ID: ${{ secrets.VIKA_DATASHEET_ID }}
      run: |
        echo "调试：检查环境变量..."
        if [ -z "$VIKA_API_TOKEN" ]; then echo "❌ VIKA_API_TOKEN 未设置"; else echo "✅ VIKA_API_TOKEN 已设置"; fi
        if [ -z "$VIKA_DATASHEET_ID" ]; then echo "❌ VIKA_DATASHEET_ID 未设置"; else echo "✅ VIKA_DATASHEET_ID 已设置"; fi
        echo ""
        python fund_tracker.py
    
    - name: 显示完成信息
      if: success()
      run: |
        echo "✅ 基金估值更新成功！"
        echo "⏰ 更新时间: $(date '+%Y-%m-%d %H:%M:%S')"
