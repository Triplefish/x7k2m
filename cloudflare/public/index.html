<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Tracker</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10b981',
                        danger: '#ef4444',
                        background: '#f8fafc',
                        surface: '#ffffff'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // å½“å‰ç”¨æˆ·ï¼ˆuser1 æˆ– user2ï¼‰ä» URL ?user= è¯»å–ï¼Œé»˜è®¤ user1
        const CURRENT_USER = new URLSearchParams(window.location.search).get('user') || 'user1';
        const API_USER = `?user=${CURRENT_USER}`;

        // é£é™©è¯„çº§é¡ºåºï¼ˆç”¨äºæ’åºï¼‰
        const RISK_ORDER = { 'R1 ä½é£é™©': 1, 'R2 ä¸­ä½é£é™©': 2, 'R3 ä¸­ç­‰é£é™©': 3, 'R4 ä¸­é«˜é£é™©': 4, 'R5 é«˜é£é™©': 5 };

        // --- Icons ---
        const IconTrendingUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const IconTrendingDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>;
        const IconRefresh = ({ spin }) => <svg className={spin ? "animate-spin" : ""} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
        const IconCloud = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;

        const IconSort = ({ dir }) => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">{dir === 'asc' ? <polyline points="18 15 12 9 6 15"/> : <polyline points="6 9 12 15 18 9"/>}</svg>;

        // --- Risk Badge ---
        const RiskBadge = ({ level }) => {
            if (!level || level === 'æœªçŸ¥') return <span className="text-xs text-gray-300">â€”</span>;
            const colorMap = {
                'R1': 'bg-emerald-50 text-emerald-600 border-emerald-200',
                'R2': 'bg-blue-50 text-blue-600 border-blue-200',
                'R3': 'bg-yellow-50 text-yellow-600 border-yellow-200',
                'R4': 'bg-orange-50 text-orange-600 border-orange-200',
                'R5': 'bg-red-50 text-red-600 border-red-200',
            };
            const key = level.startsWith('R') ? level.substring(0, 2) : 'R3';
            const cls = colorMap[key] || 'bg-gray-50 text-gray-600 border-gray-200';
            return <span className={`text-xs border px-1.5 py-0.5 rounded font-mono ${cls}`}>{level}</span>;
        };

        const StatCard = ({ label, value, subValue, trend }) => {
            const colorClass = trend > 0 ? 'text-red-500' : (trend < 0 ? 'text-emerald-500' : 'text-gray-500');
            return (
                <div className="bg-white p-3 sm:p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                    <span className="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-0.5 sm:mb-1 text-center leading-tight">{label}</span>
                    <span className={`text-xl sm:text-2xl font-bold ${colorClass}`}>{value}</span>
                    {subValue && <span className="text-xs text-gray-400 mt-0.5">{subValue}</span>}
                </div>
            );
        };

        const FundRow = ({ fund, onDelete }) => {
            const isUp = parseFloat(fund['æ¶¨è·Œå¹…']) > 0;
            const isDown = parseFloat(fund['æ¶¨è·Œå¹…']) < 0;
            const trendColor = isUp ? 'text-red-500' : (isDown ? 'text-emerald-500' : 'text-gray-500');
            const diffSign = isUp ? '+' : '';
            const changePct = `${diffSign}${(parseFloat(fund['æ¶¨è·Œå¹…']) * 100).toFixed(2)}%`;

            return (
                <div className="group bg-white rounded-xl p-3 sm:p-4 mb-2 sm:mb-3 border border-gray-100 shadow-sm hover:shadow-md transition-all duration-200 fade-in">
                    {/* ä¸Šè¡Œï¼šåç§° + æ¶¨è·Œå¹… */}
                    <div className="flex items-start justify-between gap-2">
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-1.5 flex-wrap">
                                <h3 className="font-bold text-gray-800 text-sm sm:text-base">{fund['åŸºé‡‘åç§°']}</h3>
                                <span className="text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full shrink-0">{fund['åŸºé‡‘ä»£ç ']}</span>
                                <RiskBadge level={fund['é£é™©è¯„çº§']} />
                            </div>
                            <div className="text-xs text-gray-400 mt-1 flex gap-1.5 flex-wrap">
                                <span>{fund['æ¥æº']}</span><span>â€¢</span>
                                <span>{fund['ç±»å‹']}</span><span>â€¢</span>
                                <span>{fund['æ›´æ–°æ—¶é—´']}</span>
                            </div>
                        </div>
                        {/* æ¶¨è·Œå¹… â€” æœ€é‡è¦ï¼Œå³ä¸Šè§’å¤§å­— */}
                        <div className={`flex items-center gap-1 font-bold text-lg sm:text-xl shrink-0 ${trendColor}`}>
                            {isUp && <IconTrendingUp />}
                            {isDown && <IconTrendingDown />}
                            <span>{changePct}</span>
                        </div>
                    </div>

                    {/* ä¸‹è¡Œï¼šä¼°å€¼ + ç›ˆäº + åˆ é™¤ */}
                    <div className="flex items-center justify-between mt-2 pt-2 border-t border-gray-50">
                        <div className="flex gap-4 sm:gap-6">
                            <div>
                                <span className="text-xs text-gray-400 block">å½“å‰ä¼°å€¼</span>
                                <span className="font-mono text-sm font-medium text-gray-700">{fund['å½“å‰ä¼°å€¼']}</span>
                            </div>
                            <div>
                                <span className="text-xs text-gray-400 block">é¢„ä¼°ç›ˆäº</span>
                                <span className={`font-mono text-sm ${trendColor}`}>{fund['æ¶¨è·Œé¢']}</span>
                            </div>
                            <div className="hidden sm:block">
                                <span className="text-xs text-gray-400 block">æ˜¨æ—¥å‡€å€¼</span>
                                <span className="font-mono text-sm text-gray-500">{fund['æ˜¨æ—¥å‡€å€¼']}</span>
                            </div>
                        </div>
                        {/* åˆ é™¤ï¼šç§»åŠ¨ç«¯å¸¸æ˜¾ï¼ˆä½é€æ˜ï¼‰ï¼Œæ¡Œé¢ hover æ˜¾ */}
                        <button
                            onClick={() => onDelete(fund['åŸºé‡‘ä»£ç '])}
                            className="p-2 text-gray-300 hover:text-red-500 active:text-red-500 hover:bg-red-50 rounded-full transition-colors opacity-30 sm:opacity-0 sm:group-hover:opacity-100"
                            title="åˆ é™¤"
                        >
                            <IconTrash />
                        </button>
                    </div>
                </div>
            );
        }

        const Modal = ({ isOpen, onClose, title, children, footer }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/30 backdrop-blur-sm transition-opacity">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">&times;</button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                        {footer && (
                            <div className="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-2">
                                {footer}
                            </div>
                        )}
                    </div>
                </div>
            )
        }

        const AddFundForm = ({ onClose, onRefresh }) => {
            const [code, setCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [fundInfo, setFundInfo] = useState(null);
            
            // Form state
            const [formData, setFormData] = useState({
                type: 'active',
                source: 'ç†è´¢é€š',
                etf_code: '',
                etf_name: '',
                risk_level: ''
            });

            const handleSearch = async () => {
                if (!code) return;
                setLoading(true);
                try {
                    const res = await fetch(`/api/fund_info/${code}`);
                    const data = await res.json();
                    if (data.success) {
                        setFundInfo(data);
                        const newType = data.fund_name.includes('ETFè”æ¥') ? 'etf_linked'
                            : data.fund_name.includes('å€º') ? 'bond' : 'active';
                        setFormData(prev => ({ ...prev, type: newType, risk_level: data.risk_level || '' }));
                    } else {
                        alert('æœªæ‰¾åˆ°è¯¥åŸºé‡‘ä¿¡æ¯');
                        setFundInfo(null);
                    }
                } catch (e) {
                    alert('æŸ¥è¯¢å‡ºé”™');
                } finally {
                    setLoading(false);
                }
            };

            const handleSubmit = async () => {
                if (!fundInfo) return;
                
                try {
                    const payload = {
                        code: code,
                        name: fundInfo.fund_name,
                        source: formData.source,
                        type: formData.type,
                        risk_level: formData.risk_level || undefined,
                        etf_code: formData.type === 'etf_linked' ? formData.etf_code : undefined,
                        etf_name: formData.type === 'etf_linked' ? formData.etf_name : undefined,
                    };

                    const res = await fetch(`/api/funds${API_USER}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.success) {
                        onRefresh();
                        onClose();
                    } else {
                        alert(data.message || 'æ·»åŠ å¤±è´¥');
                    }
                } catch(e) {
                    alert('ç½‘ç»œé”™è¯¯');
                }
            };

            return (
                <div className="space-y-4">
                    <div className="flex gap-2">
                        <input 
                            type="text" 
                            className="flex-1 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/20"
                            placeholder="è¾“å…¥åŸºé‡‘ä»£ç  (å¦‚: 002963)"
                            value={code}
                            onChange={e => setCode(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && handleSearch()}
                        />
                        <button 
                            onClick={handleSearch}
                            disabled={loading || !code}
                            className="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-700 disabled:opacity-50 transition-colors"
                        >
                            {loading ? '...' : 'æŸ¥è¯¢'}
                        </button>
                    </div>

                    {fundInfo && (
                        <div className="space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <div>
                                <label className="text-xs text-gray-500 font-medium block mb-1">åŸºé‡‘åç§°</label>
                                <div className="font-semibold text-gray-800">{fundInfo.fund_name}</div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs text-gray-500 font-medium block mb-1">æ¥æº</label>
                                    <select 
                                        className="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-sm"
                                        value={formData.source}
                                        onChange={e => setFormData({...formData, source: e.target.value})}
                                    >
                                        <option value="ç†è´¢é€š">ç†è´¢é€š</option>
                                        <option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 font-medium block mb-1">ç±»å‹</label>
                                    <select 
                                        className="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-sm"
                                        value={formData.type}
                                        onChange={e => setFormData({...formData, type: e.target.value})}
                                    >
                                        <option value="active">ä¸»åŠ¨å‹/æ··åˆ</option>
                                        <option value="bond">å€ºåˆ¸å‹</option>
                                        <option value="etf_linked">ETFè”æ¥</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs text-gray-500 font-medium block mb-1">é£é™©è¯„çº§ (è‡ªåŠ¨è·å–å¯è¦†ç›–)</label>
                                <select
                                    className="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-sm"
                                    value={formData.risk_level}
                                    onChange={e => setFormData({...formData, risk_level: e.target.value})}
                                >
                                    <option value="">è‡ªåŠ¨</option>
                                    <option value="R1 ä½é£é™©">R1 ä½é£é™©</option>
                                    <option value="R2 ä¸­ä½é£é™©">R2 ä¸­ä½é£é™©</option>
                                    <option value="R3 ä¸­ç­‰é£é™©">R3 ä¸­ç­‰é£é™©</option>
                                    <option value="R4 ä¸­é«˜é£é™©">R4 ä¸­é«˜é£é™©</option>
                                    <option value="R5 é«˜é£é™©">R5 é«˜é£é™©</option>
                                </select>
                                {fundInfo.risk_level && <p className="text-xs text-emerald-600 mt-1">è‡ªåŠ¨æ£€æµ‹: {fundInfo.risk_level}</p>}
                            </div>

                            {formData.type === 'etf_linked' && (
                                <div className="space-y-2 pt-2 border-t border-gray-200">
                                    <input 
                                        className="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm"
                                        placeholder="å…³è”ETFä»£ç  (é€‰å¡«)"
                                        value={formData.etf_code}
                                        onChange={e => setFormData({...formData, etf_code: e.target.value})}
                                    />
                                    <input 
                                        className="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm"
                                        placeholder="å…³è”ETFåç§° (é€‰å¡«)"
                                        value={formData.etf_name}
                                        onChange={e => setFormData({...formData, etf_name: e.target.value})}
                                    />
                                </div>
                            )}

                            <button 
                                onClick={handleSubmit}
                                className="w-full bg-primary text-white py-2 rounded-lg hover:bg-emerald-600 font-medium shadow-sm shadow-emerald-200 transition-all mt-2"
                            >
                                ç¡®è®¤æ·»åŠ 
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [updatingRisk, setUpdatingRisk] = useState(false);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [sortBy, setSortBy] = useState('æ¶¨è·Œå¹…');
            const [sortDir, setSortDir] = useState('desc'); // desc é™åºï¼Œasc å‡åº
            const [groupBy, setGroupBy] = useState('none'); // none | æ¥æº | ç±»å‹ | é£é™©è¯„çº§

            const loadData = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`/api/estimates${API_USER}`);
                    const json = await res.json();
                    setData(json);
                } catch (err) {
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const handleSync = async () => {
                if(!confirm('ç¡®è®¤åŒæ­¥åˆ°ç»´æ ¼è¡¨?')) return;
                setSyncing(true);
                try {
                    const res = await fetch(`/api/sync${API_USER}`, { method: 'POST' });
                    const json = await res.json();
                    if(json.success) alert('åŒæ­¥æˆåŠŸ');
                    else alert('åŒæ­¥å¤±è´¥: ' + json.message);
                } catch (e) {
                    alert('åŒæ­¥é”™è¯¯');
                } finally {
                    setSyncing(false);
                }
            };

            const handleUpdateRiskLevels = async () => {
                if(!confirm('å°†ä¸ºæ‰€æœ‰ç¼ºå°‘é£é™©è¯„çº§çš„åŸºé‡‘è‡ªåŠ¨æŠ¤å–ï¼ˆå¯èƒ½éœ€è¦å‡ åç§’ï¼‰ï¼Œç¡®è®¤ç»§ç»­?')) return;
                setUpdatingRisk(true);
                try {
                    const res = await fetch(`/api/update_risk_levels${API_USER}`, { method: 'POST' });
                    const json = await res.json();
                    if(json.success) {
                        alert(`æ›´æ–°å®Œæˆï¼Œå…±è¡¥å…¨ ${json.updated} ä¸ªåŸºé‡‘çš„é£é™©è¯„çº§`);
                        loadData();
                    } else alert('æ›´æ–°å¤±è´¥: ' + json.message);
                } catch (e) {
                    alert('è¯·æ±‚å‡ºé”™');
                } finally {
                    setUpdatingRisk(false);
                }
            };

            const handleDelete = async (code) => {
                if(!confirm(`ç¡®è®¤åˆ é™¤ä»£ç ä¸º ${code} çš„åŸºé‡‘?`)) return;
                try {
                    await fetch(`/api/funds/${code}${API_USER}`, { method: 'DELETE' });
                    loadData();
                } catch(e) {
                    alert('åˆ é™¤å¤±è´¥');
                }
            };

            const toggleSort = (field) => {
                if (sortBy === field) {
                    setSortDir(d => d === 'desc' ? 'asc' : 'desc');
                } else {
                    setSortBy(field);
                    setSortDir('desc');
                }
            };

            useEffect(() => {
                loadData();
            }, []);

            // Dashboard Stats
            const stats = useMemo(() => {
                if(!data.length) return { avgChange: 0, upCount: 0, downCount: 0 };
                let totalPct = 0;
                let up = 0;
                let down = 0;
                let validCount = 0;
                
                data.forEach(d => {
                    const pct = parseFloat(d['æ¶¨è·Œå¹…']);
                    if(!isNaN(pct)) {
                        totalPct += pct;
                        if(pct > 0) up++; 
                        if(pct < 0) down++;
                        validCount++;
                    }
                });
                return {
                    avgChange: validCount ? (totalPct / validCount * 100).toFixed(2) : 0,
                    upCount: up,
                    downCount: down
                };
            }, [data]);

            // æ’åº + åˆ†ç»„è®¡ç®—
            const processedData = useMemo(() => {
                const sorted = [...data].sort((a, b) => {
                    let va, vb;
                    if (sortBy === 'æ¶¨è·Œå¹…') {
                        va = parseFloat(a['æ¶¨è·Œå¹…']) || 0;
                        vb = parseFloat(b['æ¶¨è·Œå¹…']) || 0;
                    } else if (sortBy === 'åŸºé‡‘åç§°') {
                        va = a['åŸºé‡‘åç§°'] || '';
                        vb = b['åŸºé‡‘åç§°'] || '';
                        return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
                    } else if (sortBy === 'é£é™©è¯„çº§') {
                        va = RISK_ORDER[a['é£é™©è¯„çº§']] || 99;
                        vb = RISK_ORDER[b['é£é™©è¯„çº§']] || 99;
                    } else if (sortBy === 'æ¥æº') {
                        va = a['æ¥æº'] || '';
                        vb = b['æ¥æº'] || '';
                        return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
                    } else {
                        return 0;
                    }
                    return sortDir === 'desc' ? vb - va : va - vb;
                });

                if (groupBy === 'none') return [{ key: null, items: sorted }];

                const groups = {};
                sorted.forEach(f => {
                    const key = f[groupBy] || 'æœªçŸ¥';
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(f);
                });

                // åˆ†ç»„é¡ºåº
                let keys = Object.keys(groups);
                if (groupBy === 'é£é™©è¯„çº§') {
                    keys = keys.sort((a, b) => (RISK_ORDER[a] || 99) - (RISK_ORDER[b] || 99));
                } else {
                    keys = keys.sort();
                }
                return keys.map(k => ({ key: k, items: groups[k] }));
            }, [data, sortBy, sortDir, groupBy]);

            return (
                <div className="min-h-screen pb-12">
                    {/* Header */}
                    <div className="bg-white border-b border-gray-200 sticky top-0 z-30 bg-opacity-80 backdrop-blur-md">
                        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary">
                                    <IconTrendingUp />
                                </div>
                                <div>
                                    <h1 className="font-bold text-xl text-gray-900 tracking-tight">åŸºé‡‘è¿½è¸ª</h1>
                                    <p className="text-xs text-gray-400">å®æ—¶ä¼°å€¼çœ‹æ¿</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button 
                                    onClick={loadData} 
                                    className="p-2 text-gray-500 hover:text-primary hover:bg-gray-50 rounded-lg transition-all"
                                    title="åˆ·æ–°ä¼°å€¼"
                                >
                                    <IconRefresh spin={loading} />
                                </button>
                                <button 
                                    onClick={handleUpdateRiskLevels}
                                    disabled={updatingRisk}
                                    className="flex items-center gap-1.5 p-2 sm:px-3 sm:py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-xs font-medium transition-colors disabled:opacity-50"
                                    title="æ‰¹é‡è¡¥å…¨æ‰€æœ‰åŸºé‡‘çš„é£é™©è¯„çº§"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                    <span className="hidden sm:inline">{updatingRisk ? 'è·å–ä¸­...' : 'æ›´æ–°è¯„çº§'}</span>
                                </button>
                                <button 
                                    onClick={handleSync}
                                    disabled={syncing}
                                    className="flex items-center gap-1.5 p-2 sm:px-3 sm:py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-xs font-medium transition-colors disabled:opacity-50"
                                    title="åŒæ­¥åˆ°ç»´æ ¼è¡¨"
                                >
                                    <IconCloud />
                                    <span className="hidden sm:inline">{syncing ? 'åŒæ­¥ä¸­...' : 'åŒæ­¥'}</span>
                                </button>
                                <button 
                                    onClick={() => setIsAddModalOpen(true)}
                                    className="flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 text-sm font-medium shadow-lg shadow-gray-200 transition-all"
                                >
                                    <IconPlus />
                                    <span>æ·»åŠ </span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-4xl mx-auto px-4 py-4 sm:py-8">
                        
                        {/* Stats Row */}
                        <div className="grid grid-cols-3 gap-4 mb-8">
                            <StatCard 
                                label="å¹³å‡æ¶¨è·Œ" 
                                value={`${stats.avgChange > 0 ? '+' : ''}${stats.avgChange}%`} 
                                trend={parseFloat(stats.avgChange)}
                            />
                            <StatCard 
                                label="ä¸Šæ¶¨åŸºé‡‘" 
                                value={stats.upCount} 
                                subValue="æ”¯"
                                trend={1}
                            />
                            <StatCard 
                                label="ä¸‹è·ŒåŸºé‡‘" 
                                value={stats.downCount} 
                                subValue="æ”¯"
                                trend={-1}
                            />
                        </div>

                        {/* Sort & Group Controls â€” æ¨ªå‘æ»šåŠ¨ï¼Œç§»åŠ¨ç«¯ä¸æ¢è¡Œ */}
                        <div className="overflow-x-auto -mx-4 px-4 mb-5 pb-1">
                            <div className="flex items-center gap-3 min-w-max">
                                <div className="flex items-center gap-1.5">
                                    <span className="text-xs text-gray-400 font-medium">æ’åº</span>
                                    {['æ¶¨è·Œå¹…', 'åŸºé‡‘åç§°', 'é£é™©è¯„çº§', 'æ¥æº'].map(f => (
                                        <button key={f} onClick={() => toggleSort(f)}
                                            className={`flex items-center gap-0.5 text-xs px-2.5 py-1 rounded-full border transition-all ${
                                                sortBy === f
                                                    ? 'bg-gray-900 text-white border-gray-900'
                                                    : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'
                                            }`}>
                                            {f}
                                            {sortBy === f && <IconSort dir={sortDir} />}
                                        </button>
                                    ))}
                                </div>
                                <div className="w-px h-4 bg-gray-200 shrink-0"/>
                                <div className="flex items-center gap-1.5">
                                    <span className="text-xs text-gray-400 font-medium">åˆ†ç»„</span>
                                    {[{v:'none',l:'æ— '},{v:'æ¥æº',l:'æ¥æº'},{v:'ç±»å‹',l:'ç±»å‹'},{v:'é£é™©è¯„çº§',l:'é£é™©'}].map(({v,l}) => (
                                        <button key={v} onClick={() => setGroupBy(v)}
                                            className={`text-xs px-2.5 py-1 rounded-full border transition-all ${
                                                groupBy === v
                                                    ? 'bg-gray-900 text-white border-gray-900'
                                                    : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'
                                            }`}>{l}</button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* List */}
                        <div className="space-y-1">
                            {loading && data.length === 0 ? (
                                <div className="text-center py-12 text-gray-400">åŠ è½½ä¸­...</div>
                            ) : processedData.length > 0 && processedData[0].items.length > 0 ? (
                                processedData.map(group => (
                                    <div key={group.key || 'all'}>
                                        {group.key && (
                                            <div className="flex items-center gap-2 mb-2 mt-4 first:mt-0">
                                                <span className="text-xs font-semibold text-gray-500 uppercase tracking-wider">{group.key}</span>
                                                <span className="text-xs text-gray-300 bg-gray-100 px-1.5 py-0.5 rounded-full">{group.items.length}</span>
                                                <div className="flex-1 h-px bg-gray-100"/>
                                            </div>
                                        )}
                                        {group.items.map(fund => (
                                            <FundRow key={fund['åŸºé‡‘ä»£ç ']} fund={fund} onDelete={handleDelete} />
                                        ))}
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-12">
                                    <div className="bg-white w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                                        <span className="text-2xl">ğŸ“­</span>
                                    </div>
                                    <h3 className="text-gray-900 font-medium">æš‚æ— å…³æ³¨åŸºé‡‘</h3>
                                    <p className="text-gray-400 text-sm mt-1">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æŒ‰é’®å¼€å§‹è¿½è¸ªã€‚</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Modals */}
                    <Modal 
                        isOpen={isAddModalOpen} 
                        onClose={() => setIsAddModalOpen(false)}
                        title="æ·»åŠ æ–°åŸºé‡‘"
                    >
                        <AddFundForm 
                            onClose={() => setIsAddModalOpen(false)} 
                            onRefresh={loadData}
                        />
                    </Modal>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
